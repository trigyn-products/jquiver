<head>
	<link rel="stylesheet" href="${(contextPath)!''}/webjars/1.0/pqGrid/pqgrid.min.css" />
    <script src="${(contextPath)!''}/webjars/1.0/pqGrid/pqgrid.min.js"></script>    
    <script src="${(contextPath)!''}/webjars/1.0/gridutils/gridutils.js"></script>
</head>
<div class="container">
    <div class="topband">
         <#outputformat "HTML">
        <h2 class="title-cls-name float-left"> ${messageSource.getMessage('jws.managepermissions')} </h2>
        <div class="float-right">
            <select class="typeSelectDropDown" id="typeRole" onchange="handleEntityRole()">
                <#if roles ??>
                    <#list roles as role>
                        <option value="${role?api.getRoleId()}">${role?api.getRoleName()}</option>
                    </#list>
                </#if>
            </select>
            <span onclick="backToPreviousPage();">
                <input id="backBtn" class="btn btn-secondary" name="backBtn" value="${messageSource.getMessage('jws.back')}" type="button">
            </span>
                 </#outputformat>
        </div>
        <div class="clearfix"></div>
    </div>
    <div id="divManageEntityRoleGrid"></div>
</div>

<script>
document.title = "Manage Permissions";
contextPath = "${contextPath}";

$(function () {
   <#outputformat "HTML">
    let roleName = $("#typeRole option:selected").text();
	let roleId = $("#typeRole").val();
		
    let inputField = "<input type='button' class='cm-select-btn btn btn-primary whitetext' name='"+roleName+"' attr='"+roleId+"'  value='Select All' onclick='checkAllBoxes(this);' > <input type='button' class='cm-select-btn btn btn-secondary whitetext' name='"+roleName+"' attr='"+roleId+"'  value='Deselect All' onclick='checkAllBoxes(this);' >"
	let colM = [
		 { title: "${messageSource.getMessage('jws.moduleName')}", align: "center",  dataIndx: "moduleId", align: "left", halign: "center",render: moduleTypes,
        filter: { type: "select", condition: "equal",options : moduleType, listeners: ["change"]} },
        { title: "${messageSource.getMessage('jws.entityname')}", align: "center", dataIndx: "entityName", align: "left", halign: "center",
        filter: { type: "textbox", condition: "contain", listeners: ["change"]} },
        { title: "Permission", minwidth: 200, render:addCheckBox, align: "center",  dataIndx: "is_active", halign: "center", attr:"role_id", 
         filter: {type: inputField}}
 
	];
    </#outputformat>
	let dataModel = {
	   	url: contextPath+"/cf/pq-grid-data",
    };
     grid = $("#divManageEntityRoleGrid").grid({
      gridId: "manageEntityRoleGrid",
      colModel: colM,
      resizable: true,
      freezeCols: 2,
      dataModel: dataModel
  });
  handleEntityRole();
});

function backToPreviousPage() {
    location.href = contextPath + "/cf/um";
}

var grid;
var contextPath = "${contextPath}";
var moduleType = [{"": "All"}];
$.ajax({
    type: "GET",
    url: contextPath + "/cf/modules",
    async: false,
    success: function(data) {
        for(let counter = 0; counter < data.length; ++counter) {
            let object = data[counter];
            let details = new Object()
            details[object["moduleId"]] = object["moduleName"];
            moduleType.push(details);
        }
    }
});

function moduleTypes(uiObject) {
    let cellValue = uiObject.rowData.moduleId;
	let moduleTypeName = moduleType.find(el => el[cellValue])[cellValue];
    return moduleTypeName;
}

function checkAllBoxes(uiObject) {
    let attrChecked = uiObject.value == "Select All" ? 1 : 0;
    let entityDataList = [];
    let roleId = uiObject.getAttribute("attr");
    let currentPageRecords = grid.pqGrid("option", "dataModel.data");
    $.each(currentPageRecords, function(key, value) {
        let entityData = new Object();
        
        if($("#" + value["entityRoleId"] + "_" + roleId).prop("checked") != attrChecked) {
	        $("#" + value["entityRoleId"] + "_" + roleId).prop("checked", attrChecked);
	        entityData.roleId = roleId;
	        entityData.entityName = value["entityName"];
	        entityData.moduleId = value["moduleId"];
	        entityData.entityId = value["entityId"];
	        entityData.entityRoleId = value["entityRoleId"];
	        entityData.isActive = attrChecked;
	        entityDataList.push(entityData);
        }
    });
    saveEntity(entityDataList);
}

function addCheckBox(uiObject) {
    let rowIndxPage = uiObject.rowIndxPage;
    let attrChecked = uiObject.rowData["is_active"] == null ? false : uiObject.rowData["is_active"] == "0" ? false : true;
    let moduleId = uiObject.rowData.moduleId == null ? "" : uiObject.rowData.moduleId;
    var addChkBoxString = '';
    if(attrChecked) {
    	if(moduleId=='7982cc6a-6bd3-11ed-997d-7c8ae1bb24d8'){
    		addChkBoxString = "<div style='width:100%;'><center><input type='checkbox' checked onchange='saveModuleData(this);' name='isActiveCheckbox' id='" + uiObject.rowData["entityId"] + "_" + uiObject.rowData["role_id"]  + "' rowIndxPage='" + rowIndxPage + "' ></center></div>";
    	}else{
    		addChkBoxString = "<div style='width:100%;'><center><input type='checkbox' id='" + uiObject.rowData["entityRoleId"] + "_" + uiObject.rowData["role_id"]  + "' checked onchange='saveEntityRole(this)'  rowIndxPage='" + rowIndxPage + "' ></center></div>";
    	}
        
    } else {
    	if(moduleId=='7982cc6a-6bd3-11ed-997d-7c8ae1bb24d8'){
    		addChkBoxString = "<div style='width:100%;'><center><input type='checkbox' onchange='saveModuleData(this);' name='isActiveCheckbox' id='" + uiObject.rowData["entityId"] + "_" + uiObject.rowData["role_id"]  + "'  rowIndxPage='" + rowIndxPage + "' ></center></div>";
    	}else{
    		addChkBoxString = "<div style='width:100%;'><center><input type='checkbox' id='" + uiObject.rowData["entityRoleId"] + "_" + uiObject.rowData["role_id"] + "' onchange='saveEntityRole(this)'  rowIndxPage='" + rowIndxPage + "' ></center></div>";
    	}
        
    }
    return addChkBoxString;
}

function saveEntityRole(thisObj) {
    let entityDataList = [];
    let attrChecked = thisObj.checked == true ? 1 : 0;
    let rowData = grid.pqGrid("getRowData", { rowIndx: thisObj.getAttribute("rowIndxPage") });
    let entityRoleId = rowData["role_id"] == null ? null : rowData["entityRoleId"];
    let entityData = new Object();
    entityData.roleId = $("#typeRole").val();
    entityData.entityName = rowData["entityName"];
    entityData.moduleId = rowData["moduleId"];
    entityData.entityId = rowData["entityId"];
    entityData.entityRoleId = rowData["entityRoleId"];
    entityData.isActive = attrChecked;
    entityDataList.push(entityData);
    saveEntity(entityDataList);
}

function saveEntity(entityDataList) {
    $.ajax({
        type: "POST",
        contentType: "application/json",
        url: contextPath + "/cf/suer",
        data: JSON.stringify(entityDataList),
        success: function(data) {}
    });
}

function changeRole() {    
    if($("#divManageEntityRoleGrid")[0] != undefined) {
        handleEntityRole();
    }
}

function handleEntityRole() {
	if($("#divManageEntityRoleGrid")[0] != undefined) {
		let roleName = $("#typeRole option:selected").text();
		let gridNew = $("#divManageEntityRoleGrid").pqGrid();
		if(gridNew != undefined) {

            let postData = {gridId:"manageEntityRoleGrid","cr_role_id":"str_"+$("#typeRole").val()}
            gridNew.pqGrid( "option", "dataModel.postData", postData);
			gridNew.pqGrid("refreshDataAndView");
		
		}
	}    
}

//Add logic to save form data
function saveModuleData (thisObj){
   
  let roleModule = new Object();
  var roleModuleArray = thisObj.id.split("_")
  roleModule.roleModuleId = thisObj.getAttribute("roleModuleId");
  roleModule.moduleId = roleModuleArray[0];
  roleModule.roleId = roleModuleArray[1];
  roleModule.isActive = ($(thisObj).is(":checked") ? 1 : 0);
	$.ajax({
        type : "POST",
        contentType : "application/json",
        url : contextPath+"/cf/srm",
        data : JSON.stringify(roleModule),
        success: function(data) {
        }
    });
}

</script>